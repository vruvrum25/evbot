# data/polymarket/websocket.py
import logging
import time
import threading
from py_clob_client.client import ClobClient
from config.settings import Config

logger = logging.getLogger(__name__)

class MarketDataStream:
    _ws_client = None
    _active_token_id = None # ID —Ç–æ–∫–µ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–ª—É—à–∞–µ–º —Å–µ–π—á–∞—Å

    @classmethod
    def start_stream(cls, token_id):
        """
        –ù–∞—á–∏–Ω–∞–µ—Ç —Å–ª—É—à–∞—Ç—å —Ü–µ–Ω—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, YES ETH).
        –ï—Å–ª–∏ —É–∂–µ —Å–ª—É—à–∞–µ—Ç –¥—Ä—É–≥–æ–π - –ø–µ—Ä–µ–ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è.
        """
        if cls._active_token_id == token_id:
             return # –£–∂–µ —Å–ª—É—à–∞–µ–º —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω, –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω–∞–¥–æ

        cls._active_token_id = token_id
        logger.info(f"üì° WS: –ù–∞—á–∏–Ω–∞—é —Å–ª—É—à–∞—Ç—å —Ü–µ–Ω—ã –¥–ª—è —Ç–æ–∫–µ–Ω–∞ [{token_id}]...")

        # –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ —É–∂–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Ä—ã–Ω–∫–∞ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π
        if cls._ws_client and cls._ws_client.is_alive():
             logger.info("üì° WS: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å—Ç–∞—Ä—ã–π –ø–æ—Ç–æ–∫...")
             # –¢—É—Ç –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ª–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏,
             # –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —á–∞—Å—Ç–æ –ª–µ–≥—á–µ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç.
             pass 

        # –ó–∞–ø—É—Å–∫–∞–µ–º WS –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞
        ws_thread = threading.Thread(target=cls._run_websocket, args=(token_id,), daemon=True)
        ws_thread.start()

    @classmethod
    def _run_websocket(cls, token_id):
        """–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∫—Ä—É—Ç–∏—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ."""
        try:
            # –°–æ–∑–¥–∞–µ–º –í–†–ï–ú–ï–ù–ù–û–ì–û –∫–ª–∏–µ–Ω—Ç–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            # (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏ –æ–±—â–µ–≥–æ, –Ω–æ —Ç–∞–∫ –Ω–∞–¥–µ–∂–Ω–µ–µ –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤)
            client = ClobClient(host=Config.HOST, key=Config.PRIVATE_KEY, chain_id=Config.CHAIN_ID)
            
            # –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ö–ê–ñ–î–û–ú –Ω–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã
            def on_message(msg):
                # –¢—É—Ç –º—ã –±—É–¥–µ–º –ø–æ–ª—É—á–∞—Ç—å —Å—ã—Ä—ã–µ JSON-—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–∏—Ä–∂–∏
                # –ù–∞–ø—Ä–∏–º–µ—Ä: [{'price': '0.55', 'side': 'SELL', 'size': '100'}]
                
                # –í –±—É–¥—É—â–µ–º –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º —ç—Ç–æ –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.
                # –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–µ–¥–µ–º –≤ –ª–æ–≥, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.
                # logger.info(f"‚ö° PRICE UPDATE: {msg}")
                
                # –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã –º–æ–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ª—É—á—à—É—é —Ü–µ–Ω—É –ø–æ–∫—É–ø–∫–∏ (BID)
                # –ù–æ —Ñ–æ—Ä–º–∞—Ç msg –Ω–∞–¥–æ –±—É–¥–µ—Ç –∏–∑—É—á–∏—Ç—å —Ç–æ—á–Ω–µ–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
                print(f"‚ö° {msg}") # –ò—Å–ø–æ–ª—å–∑—É–µ–º print –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –≤ —Ç–µ—Å—Ç–µ

            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å—Ç–∞–∫–∞–Ω (Level 2 Book)
            logger.info("üì° WS: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ! –ñ–¥—É —Ü–µ–Ω...")
            client.create_ws_client().subscribe_book(token_id, on_message)
            
            # –í–ê–ñ–ù–û: subscribe_book –æ–±—ã—á–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫, –ø–æ—ç—Ç–æ–º—É –º—ã –∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏ –µ–≥–æ –≤ Thread.
            
        except Exception as e:
            logger.error(f"üí• WS Error: {e}")
            time.sleep(5) # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–æ–º (–µ—Å–ª–∏ –±—ã –º—ã —Å–¥–µ–ª–∞–ª–∏ —Ü–∏–∫–ª)
