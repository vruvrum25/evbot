#–°–æ–∑–¥–∞–Ω–µ–∏–µ –∫–æ–Ω–Ω–µ–∫—Ç–∞ —Å clob –ø–æ–ª–∏–º–∞—Ä–∫–µ—Ç–∞

# data/polymarket/client.py
import logging
from py_clob_client.client import ClobClient
from config.settings import Config

logger = logging.getLogger(__name__)

class PolyClient:
    _client = None # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∂–∏—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

    @classmethod
    def get_client(cls):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤–æ–≥–æ –∫ —Ä–∞–±–æ—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞.
        –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –µ—â–µ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ—Ç –µ–≥–æ.
        """
        if cls._client is None:
            try:
                logger.info("üîå Connecting to Polymarket CLOB...")
                
                # 1. –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ Config
                cls._client = ClobClient(
                    host=Config.HOST,
                    key=Config.PRIVATE_KEY,
                    chain_id=Config.CHAIN_ID,
                    signature_type=1,            # –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Proxy (Email/Magic)
                    funder=Config.FUNDER_ADDRESS # –ù–∞—à Proxy-–∞–¥—Ä–µ—Å
                )
                
                # 2. –°–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ: –ø–æ–ª—É—á–∞–µ–º API –∫–ª—é—á–∏ (derive)
                # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É "–ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è" –±–∏—Ä–∂–µ
                creds = cls._client.create_or_derive_api_creds()
                cls._client.set_api_creds(creds)
                
                logger.info("‚úÖ Successfully connected and authorized!")
                
            except Exception as e:
                # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á),
                # –º—ã –¥–æ–ª–∂–Ω—ã —É–∑–Ω–∞—Ç—å –æ–± —ç—Ç–æ–º —Å—Ä–∞–∑—É.
                logger.critical(f"‚õî Connection failed: {e}")
                raise e # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞, –±–µ–∑ —Å–≤—è–∑–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–ª—å–∑—è

        return cls._client

    @classmethod
    def get_api_creds(cls):
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ API –∫–ª—é—á–∏ (–Ω—É–∂–Ω—ã –¥–ª—è WebSocket).
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤.
        """
        # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–µ–∂–¥–µ —á–µ–º –±—Ä–∞—Ç—å –µ–≥–æ –∫–ª—é—á–∏
        if cls._client is None:
            cls.get_client()
            
        return cls._client.creds





#Singleton (–û–¥–∏–Ω–æ—á–∫–∞): –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º PolyClient.get_client(). –°–∫–æ–ª—å–∫–æ –±—ã —Ä–∞–∑ –º—ã –µ–≥–æ –Ω–∏ –≤—ã–∑—ã–≤–∞–ª–∏ (–∏–∑ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π), –æ–Ω —Å–æ–∑–¥–∞—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∏ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ. –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å –∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É.

#–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Config: –ú—ã –Ω–µ –ø–∏—à–µ–º –∫–ª—é—á–∏ –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –∞ –±–µ—Ä–µ–º –∏—Ö –∏–∑ Config. –ï—Å–ª–∏ –ø–æ–º–µ–Ω—è–µ—Ç—Å—è –∫–ª—é—á, –º—ã –∏–∑–º–µ–Ω–∏–º –µ–≥–æ —Ç–æ–ª—å–∫–æ –≤ .env, –∞ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ –±—É–¥–µ–º.
